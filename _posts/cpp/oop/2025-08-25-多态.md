---
layout: post
title: C++面向对象：多态
slug: cpp-virtual-function
categories: [C++总结]
tags: [C++面向对象]
---

多态，字面意思就是“多种形态”，也就是对同一个行为具有多个不同表现形式。

C++中，多态主要指的是通过一个**基类的指针或引用**来调用**派生类的虚函数**时，程序能够**在运行时**根据**实际指向的对象**类型来决定调用哪个函数版本。

```cpp
class Base {
public:
    virtual void foo() {
       std::cout << "Base Called." << std::endl;
   }
};

class Derived : public Base
{
public:
    virtual void foo() { 
       std::cout << "Derived Called." << std::endl;
   }
};

void bar(Base *p)
{
    p->foo();
}

int main()
{
    Base b;
    Derived d;

    bar(&b); // Base Called.
    bar(&d); // Derived Called.
}
```
从上面可以看出：bar()接口根据传入的不同对象，调用不同的bar版本。

C++实现多态的关键：
+ 必须有继承关系。
+ 基类重写了派生类的虚函数。
+ 必须通过基类的指针或引用调用派生类的虚函数。

## 动态绑定和静态绑定
![](https://jacktang816.github.io/img/cpp/virtualFunction/virtualTable.png)
## 虚函数工作原理
当一个类包含虚函数时，编译器会为该类生成一个虚函数表。
1. 虚函数表：一个指针数组，其中每个指针都指向**该类的虚函数的实现**。基类和派生类**都有**自己的vtable。
1. 虚函数表指针：当创建一个包含虚函数的类的对象时，该对象会在其内存中多出一个vptr，它指向该类的vtable。

当通过基类指针或引用调用一个虚函数时，C++的运行时系统会执行以下步骤：
1. 查找vptr：通过指针或引用找到对象的vptr。
1. 访问vtable：通过vptr找到正确的vtable。
1. 调用函数：在vtable中找到对应虚函数的地址，并跳转到该地址执行代码。

这个过程发生在运行时，因此被称为动态绑定。

## 纯虚函数

## 构造函数不能是virtual

## 析构函数最好是virtual

## 参考
[C++虚函数的实现基本原理](https://jacktang816.github.io/post/virtualfunction/)

