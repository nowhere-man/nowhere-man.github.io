---
layout: post
title: x264中的行级码控
slug: x264-row-rc
categories: [视频开发]
tags: [H.264]
---

x264 中的行级码率控制
执行
x264 中的行级速率控制是通过 VBV（视频缓冲验证器）系统实现的，以便在各个帧内而不是仅在帧级别提供更精确的比特率控制。

核心实现围绕x264_ratecontrol_mb()函数ratecontrol.c:1496展开，该函数在每个宏块行的末尾被调用，以根据实际消耗的位数与预测位数来调整量化参数 (QP)。

系统使用存储在row_preds row_pred中的两个主要预测器结构，并根据当前切片类型ratecontrol.c:1362分配活动预测器。

predict_row_size()行大小预测由函数ratecontrol.c:1446-1473处理，该函数对两个预测器进行平均：绝对 SATD（绝对变换差异之和）和来自前一帧中共位行的缩放比特成本。

row_bits_so_far() 速率控制算法通过ratecontrol.c:1475-1481累积迄今为止使用的位数，并通过predict_row_size_to_end() ratecontrol.c:1483-1490 预测剩余的帧大小。

调整参数
行级速率控制可以通过几个关键参数进行调整：

QP 步骤控制：i_qp_step参数x264.h:447 限制行之间的最大 QP 变化，算法强制通过qp_max和qp_min计算ratecontrol.c:1537-1538进行界限。

速率容差：f_rate_tolerance参数x264.h:452 控制编码器遵守目标比特率的严格程度，实现方式如rc_tol行控制逻辑ratecontrol.c:1574中所述。

VBV 缓冲区设置：VBV 参数包括i_vbv_max_bitrate、i_vbv_buffer_size和f_vbv_buffer_init x264.h:453-455，通过限制最大帧大小和缓冲区填充计算ratecontrol.c:1544-1545 直接影响行级决策。

目的和好处
行级速率控制的主要目的是确保符合 VBV，同时保持最佳视觉质量分布。

VBV 兼容性：系统会根据实时缓冲区填充计算(ratecontrol.c:1589-1596)进行 QP 调整，从而防止缓冲区下溢和上溢。当 QP 跳跃过大时，它甚至可以触发行重新编码(ratecontrol.c:1622-1631)。

提升比特率精度：通过在编码过程中而非仅在帧边界处调整量化参数 (QP)，系统实现了更精确的比特率目标定位。该算法会根据实际编码结果持续更新预测器(ratecontrol.c:1518-1522)。

质量分布：当帧相对于缓冲区约束ratecontrol.c:1613-1617消耗过多的比特时，行级控制允许增加 QP，从而有助于防止复杂区域的质量下降。

线程支持：实现包括对切片线程场景的特殊处理，根据其他并发切片的估计大小调整决策ratecontrol.c:1547-1561。

笔记
行级码率控制仅在启用 VBV（b_vbv标志）时有效，因为它是专门为确保符合视频缓冲限制而设计的。系统为不同的切片类型维护单独的预测器，并通过在编码过程中持续更新的自适应预测器系数自动适应编码复杂度。