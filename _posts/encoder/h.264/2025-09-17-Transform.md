---
layout: post
title: H.264 变换
slug: h264-transform
categories: [视频开发]
tags: [H.264]
---

在视频编码中，我们通常处理的是**预测残差（Residual）**。所谓残差，就是原始图像块减去预测图像块后得到的数据。直接对残差数据进行编码效率很低，因为：

1. 残差数据在空间上仍然存在大量相关性。
1. 人眼对不同频率的噪声敏感度不同。直接编码无法利用这一点。

因此，变换和量化这两个步骤被引入，它们的目标是：

1. **变换 (Transform)**：将空间域（spatial domain）的残差数据，通过类似离散余弦变换（DCT）的数学运算，转换到频率域（frequency domain）。
   + **能量集中**：变换后，残差块的大部分能量（重要信息）会集中在左上角的少数几个低频系数上。右下角的大量高频系数通常会接近于零。
   + **去相关性**：消除残差像素之间的空间相关性，使得数据更适合压缩。
1. **量化 (Quantization)**：这是 H.264 中**主要的有损压缩步骤**。它对变换后的频率系数进行“粗化”处理。
   + **数据削减**：通过除以一个量化步长（Quantization Step）并取整，大幅减少需要表示的数据量。那些接近零的高频系数在量化后会直接变成零，这对于后续的熵编码（如 CABAC/CAVLC）极为有利。
   + **码率控制**：量化是控制视频码率和质量的核心工具。量化越粗糙（步长越大），压缩率越高，但图像质量损失也越大。

**流程图 (ASCII Art):**

```
                  +-----------------+      +-----------------+      +-----------------+
Original Block -> |   Prediction    | ->   |   Residual      | ->   |   Transform     |
                  +-----------------+      | (Spatial Domain)|      | (To Frequency)  |
                                           +-----------------+      +-----------------+
                                                                            |
                                                                            v
                  +-----------------+      +-----------------+      +-----------------+
Entropy Coding -> | Quantized Coeffs| <-   |  Quantization   | <-   | Freq. Coefficients|
(e.g., CABAC)     | (Many are zero) |      | (Lossy Step)    |      | (Energy Compacted)|
                  +-----------------+      +-----------------+      +-----------------+
```



### 2. H.264 中的整数变换



早期的视频标准（如 MPEG-2）使用浮点数的离散余弦变换（DCT）。但这会导致编码器和解码器之间因浮点数精度问题产生**“失配”（mismatch）**，从而造成图像错误累积。

H.264 的一个重大创新是采用了**整数变换**，它完全避免了浮点运算，保证了编码器和解码器之间可以精确匹配。

#### 2.1 核心变换：4x4 整数变换

这是 H.264中最常用、最基础的变换，应用于亮度和色度残差的 4x4 块。

假设我们有一个 4x4 的残差块 X：

$$X = \begin{bmatrix} x_{00} & x_{01} & x_{02} & x_{03} \\ x_{10} & x_{11} & x_{12} & x_{13} \\ x_{20} & x_{21} & x_{22} & x_{23} \\ x_{30} & x_{31} & x_{32} & x_{33} \end{bmatrix} $$

变换后的系数块 $Y$ 通过以下公式计算：$$Y = C \cdot X \cdot C^T$$其中 $C$ 是变换矩阵，$C^T$ 是它的转置。H.264 定义的变换矩阵 $C$ 是：

$$ C = \begin{bmatrix} 1 & 1 & 1 & 1 \\ 2 & 1 & -1 & -2 \\ 1 & -1 & -1 & 1 \\ 1 & -2 & 2 & -1 \end{bmatrix} $$

**关键点**： - 这是一个二维变换，等效于先对 $X$ 的每一行进行一维变换（乘以 $C^T$），然后对结果的每一列进行一维变换（乘以 $C$）。

- 矩阵中只有整数 1 和 2，在硬件或软件实现中可以完全用加法和位移（shift）运算来代替乘法，效率极高。
- 变换后的左上角系数 $y\_{00}$ 称为 **DC 系数（直流分量）**，它代表了该 4x4 块的平均能量。其他 15 个系数称为 **AC 系数（交流分量）**，代表不同频率的细节。

#### 2.2 Hadamard 变换

在进行了 4x4 变换后，每个 4x4 块都会产生一个 DC 系数。对于一个 16x16 的亮度宏块，就会有 16 个 DC 系数。这些 DC 系数之间仍然存在相关性。因此，H.264 会将这 16 个 DC 系数组织成一个 4x4 的块，并对其进行一次额外的 **Hadamard 变换**。 $$Y_{DC} = H \cdot D \cdot H^T$$ 其中 $D$ 是由 16 个 DC 系数组成的 4x4 块， $H$ 是 Hadamard 变换矩阵：
$$H = \begin{bmatrix} 1 & 1 & 1 & 1 \\ 1 & 1 & -1 & -1 \\ 1 & -1 & -1 & 1 \\ 1 & -1 & 1 & -1 \end{bmatrix} $$
同样，这个变换也只包含 `+1` 和 `-1`，计算非常高效。色度块（Chroma）的 DC 系数也会进行一个 2x2 的 Hadamard 变换。

#### 2.3 8x8 整数变换

为了更好地处理高清（HD）视频中的平坦区域，H.264 的 High Profile 引入了 8x8 的整数变换。其原理与 4x4 变换类似，但使用了更大的变换块和更复杂的 8x8 变换矩阵，能更有效地集中大块平坦区域的能量。
