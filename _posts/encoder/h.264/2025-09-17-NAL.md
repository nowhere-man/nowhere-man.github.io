---
layout: post
title: H.264 SPS和PPS总结
slug: h264-sps-pps
categories: [视频开发]
tags: [H.264]
---

**SPS (Sequence Parameter Set，序列参数集)** 和 **PPS (Picture Parameter Set，图像参数集)** 的作用。

简单来说，SPS 和 PPS 就像是播放 H.264 视频前的“说明书”和“配置单”。解码器在解码实际的视频画面数据之前，必须先获取并解析这两个参数集，否则就完全不知道如何正确地渲染图像。

它们将一些在整个视频序列或一系列图像中保持不变的公共信息提取出来，独立于视频帧数据进行传输。这样做有几个核心优势：

1. **提高编码效率**：避免在每个视频帧（Slice）的头部重复携带这些信息，显著减少了码流的冗余。
1. **增强灵活性和容错性**：允许在不重新发送SPS的情况下，通过发送新的PPS来改变某些图像的编码参数，方便码流切换等操作。
1. **提供解码器初始化信息**：让解码器提前知道视频流的全局特性和解码所需的必要配置。

------



### SPS (Sequence Parameter Set) - 序列参数集：全局的“说明书”



SPS 包含的是针对 **整个视频序列（一个或多个连续的视频帧）** 的全局编码参数。这些参数在整个视频序列中通常是固定不变的。可以把它想象成是视频的“档案信息”或“播放说明书”，一旦确定，解码器就知道了解码这个序列所需的所有基础信息。

**SPS 的主要作用和包含的关键信息：**

1. **定义解码器的能力和限制 (Profile & Level)**
   + `profile_idc`: 标识了视频流所使用的编码配置（Profile），例如 Baseline Profile、Main Profile、High Profile 等。解码器可以根据这个值判断自己是否有能力解码该视频流。
   + `level_idc`: 标识了视频流的级别（Level），规定了码率、分辨率、帧率等参数的上限。解码器根据 Level 可以提前分配好足够的内存和计算资源。
1. **定义图像的基本尺寸**
   + `pic_width_in_mbs_minus1`: 图像的宽度（以宏块为单位）。
   + `pic_height_in_map_units_minus1`: 图像的高度（以宏块为单位）。
   + 通过这些值，解码器可以计算出视频的精确分辨率。
1. **定义帧率和时序信息 (VUI - Video Usability Information)**
   + SPS 中可选的 VUI 部分包含了视频的帧率、宽高比、色彩空间（如 BT.709）等信息，有助于播放器正确地渲染和同步视频。
1. **定义参考帧相关的核心信息**
   + `max_num_ref_frames`: 解码器需要为长期和短期参考帧分配的最大缓冲区数量。这是解码过程中内存管理的关键参数。
   + `gaps_in_frame_num_value_allowed_flag`: 是否允许帧序号不连续，这与网络的丢包处理有关。

可以理解为，SPS 提供的参数是解码一个视频序列的“地基”，一旦 SPS 丢失或错误，整个视频序列都将无法解码。

------



### PPS (Picture Parameter Set) - 图像参数集：局部的“配置单”



PPS 包含的是针对 **一个序列中的一个或多个图像（帧）** 的编码参数。一个序列中可以只有一个 PPS，也可以有多个 PPS。解码器在解码具体的图像时，会根据该图像引用的 PPS ID 来查找对应的配置信息。

可以把它想象成是具体某一类场景或某几帧画面的“拍摄参数”或“渲染配置单”。

**PPS 的主要作用和包含的关键信息：**

1. **熵编码模式选择**
   + `entropy_coding_mode_flag`: 指明了当前图像使用的是哪种熵编码方法。H.264 主要有两种：基于上下文的自适应可变长编码 (CAVLC) 和基于上下文的自适应二进制算术编码 (CABAC)。CABAC 压缩效率更高，但计算更复杂。这是解码像素数据的核心参数之一。
1. **量化参数 (Quantization)**
   + `pic_init_qp_minus26`: 图像的初始量化参数 (QP)。QP 值直接影响视频的压缩率和质量。
   + `deblocking_filter_control_present_flag`: 是否使用去块效应滤波器，以及滤波器的相关控制参数。这是改善视频主观质量的重要环节。
1. **参考帧列表管理**
   + `num_ref_idx_l0/l1_active_minus1`: 定义了在进行P帧和B帧的运动预测时，前向（l0）和后向（l1）参考帧列表的大小。
1. **定义图像组和切片 (Slice) 信息**
   + `num_slice_groups_minus1`: 图像中Slice Group的数量，用于实现灵活宏块排序（FMO）等高级容错功能。

一个视频序列（由一个 SPS 定义）可以包含多个 PPS。比如，视频的前半段使用一种量化和熵编码策略（PPS A），后半段为了提高压缩率切换到另一种策略（PPS B）。解码器只需要在需要切换时接收新的 PPS 即可，无需重新接收庞大的 SPS。



### SPS 和 PPS 的关系与传输

+ **层级关系**: **SPS -> PPS -> Slice Header -> Slice Data**。解码器首先解析 SPS，然后根据 Slice Header 中指定的 PPS ID 去解析对应的 PPS，最后利用这两个参数集的信息来解码 Slice Data。
+ **传输时机**: SPS 和 PPS 通常在视频流的开头，与 **IDR 帧（即时解码刷新帧，一种特殊的I帧）** 绑定在一起传输。因为 IDR 帧是一个序列的绝对刷新点，解码器可以从任何一个 IDR 帧开始独立解码，所以必须确保解码器在解码 IDR 帧之前已经拥有了正确的 SPS 和 PPS。
