---
layout: post
title: TCP协议 - 1 基础
slug: tcp-basics
categories: [网络编程]
tags: [TCP]
---

## TCP简介

## TCP Header

```
  0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |          Source Port          |       Destination Port        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                        Sequence Number                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Acknowledgment Number                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Data |       |C|E|U|A|P|R|S|F|                               |
   | Offset| Rsrvd |W|C|R|C|S|S|Y|I|            Window             |
   |       |       |R|E|G|K|H|T|N|N|                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |           Checksum            |         Urgent Pointer        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           [Options]                           |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               :
   :                             Data                              :
   :                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

          Note that one tick mark represents one bit position.
```
各字段含义：

+ 源端口(Source Port)：发送端的tcp端口号
+ 目的端口(Destination Port)：接收端的端口号
+ 序号(Sequence Number)：如果SYN设置，序号为初始序号（ISN），在建立连接时由客户端/服务端随机生成，建立连接后，序号从ISN+1开始，每发送一个报文段，序列号都会累加该报文段所携带的数据字节数。
+ 确认号(Acknowledgment Number)：代表接收方期望收到的下一个字节的序列号。ACK = 接收到的最小序号 + 1
+ 数据偏移(Data Offset)：
    + 占4比特。
    + 一个完整的TCP报文头长度可以在20到60字节之间变化，数据偏移字段用于**让接收方知道TCP报文头的实际长度**。
    + 数据偏移的值以32bit为单位，TCP报文头长度（字节） = 数据偏移字段的值 × 4，
    + 数据偏移字段的值的范围是5到15。
+ 保留(Reserved)：占4比特，必须设置为0。
+ 控制位：
    + CWR：Congestion Window Reduced，拥塞窗口已减少，表示发送方已经接收到ECN-Echo标志位的ACK，并且已经减少了拥塞窗口大小。
    + ECE：ECN-Echo，ECN回显，表示接收方支持ECN（Explicit Congestion Notification），并且在接收到拥塞通知时设置该标志位。
    + URG：表示TCP包的紧急指针域有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据;
    + ACK：表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中;为1表示应答域有效，反之为0;
    + PSH：表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队;
    + RST：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包;
    + SYN：表示同步序号，TCP连接的建立和断开都需要使用SYN标志位;
    + FIN：表示发送端已经不会再传输数据。
+ 窗口(Window)：TCP里很重要的一个机制，占2字节，表示报文段发送方期望接收的字节数，可接收的序号范围是从接收方的确认号开始到确认号加上窗口大小之间的数据。后面会有实例讲解。
+ 校验和(Checksum)：校验和包含了伪首部、TCP首部和数据，校验和是TCP强制要求的，由发送方计算，接收方验证。
+ 紧急指针(Urgent Pointer)：URG标志为1时，紧急指针有效，表示数据需要优先处理。紧急指针指出在TCP段中的紧急数据的最后一个字节的序号，使接收方可以知道紧急数据共有多长。
+ 选项(Options)：最常用的选项是最大段大小（Maximum Segment Size，MSS），向对方通知本机可以接收的最大TCP段长度。MSS选项只在建立连接的请求中发送。


## 参考资料
+ [RFC-9293 ](https://www.rfc-editor.org/rfc/rfc9293.html)
+ [TCP协议详解及实战解析](https://blog.csdn.net/mumubumaopao/article/details/107929767)