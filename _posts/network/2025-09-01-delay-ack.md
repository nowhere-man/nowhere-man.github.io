---
layout: post
title: TCP协议：延时ACK与Nagle算法
slug: tcp-delay-ack
categories: [网络传输]
tags: [TCP]
---

## 延时ACK
延时ACK是一种优化TCP性能的机制。它的核心思想是：接收方不立即发送对每个数据包的确认（ACK），而是等待一小段时间，如果在这段时间内有数据需要发送给对方，就把ACK和数据**捎带**一起发送。

> linux实现中，每连续收到两个完整的报文段，或者等待40毫秒（延时ACK计时器超时时间）未收到新的报文段时，就会发送ACK。


## Nagle算法

Nagle算法是一种通过减少**小的数据包数量**来改善网络传输效率的算法。它的核心思想是：
+ 当一个TCP连接中有在传输数据（已经发送，但是还未经确认的数据）时，**小的报文段（长度小于MSS）不会被立即发送**，而是会被缓存在发送缓冲区中，直到所有未确认的数据都被确认（收到ACK），或者有足够的数据积累到可以发送一个满MSS大小的报文段时，才会将这些小数据包一起发送出去。

Nagle算法的目的是减少网络中小包的数量，因为每个TCP报文段都有固定的头部开销（20字节），发送大量小包会浪费大量带宽。


## 延时ACK和Nagle算法的结合

当延时ACK和Nagle算法在TCP连接的两端同时启用时，它们可能会陷入一个**短暂的死锁**（延时ACK计时器超时时间）状态，导致延迟显著增加。

举例：
1. 客户端发送一个数据包。
1. 服务器收到数据包，根据延时ACK规则，服务器不会立即发送ACK，而是启动一个40ms计时器，等待捎带数据。
1. 服务器处理这个数据后，需要发送一个响应数据包。根据Nagle算法规则，服务器在发送响应数据前，会检查是否收到了上一个数据包的ACK。
1. 但此时，延时ACK的计时器还没到期，服务器还没有发送ACK。
1. 因此，Nagle算法会阻止服务器发送响应数据，并将响应数据缓存起来。

解决方案通常是关闭Nagle算法。（而不是关闭延时ACK）