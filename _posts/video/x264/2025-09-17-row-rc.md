---
layout: post
title: x264中的行级码控
slug: x264-row-rc
categories: [视频开发]
tags: [H.264]
---

x264 中的行级码率控制
执行
x264 中的行级速率控制是通过 VBV（视频缓冲验证器）系统实现的，以便在各个帧内而不是仅在帧级别提供更精确的比特率控制。

核心实现围绕x264_ratecontrol_mb()函数ratecontrol.c:1496展开，该函数在每个宏块行的末尾被调用，以根据实际消耗的位数与预测位数来调整量化参数 (QP)。

系统使用存储在row_preds row_pred中的两个主要预测器结构，并根据当前切片类型ratecontrol.c:1362分配活动预测器。

predict_row_size()行大小预测由函数ratecontrol.c:1446-1473处理，该函数对两个预测器进行平均：绝对 SATD（绝对变换差异之和）和来自前一帧中共位行的缩放比特成本。

row_bits_so_far() 速率控制算法通过ratecontrol.c:1475-1481累积迄今为止使用的位数，并通过predict_row_size_to_end() ratecontrol.c:1483-1490 预测剩余的帧大小。

调整参数
行级速率控制可以通过几个关键参数进行调整：

QP 步骤控制：i_qp_step参数x264.h:447 限制行之间的最大 QP 变化，算法强制通过qp_max和qp_min计算ratecontrol.c:1537-1538进行界限。

速率容差：f_rate_tolerance参数x264.h:452 控制编码器遵守目标比特率的严格程度，实现方式如rc_tol行控制逻辑ratecontrol.c:1574中所述。

VBV 缓冲区设置：VBV 参数包括i_vbv_max_bitrate、i_vbv_buffer_size和f_vbv_buffer_init x264.h:453-455，通过限制最大帧大小和缓冲区填充计算ratecontrol.c:1544-1545 直接影响行级决策。

目的和好处
行级速率控制的主要目的是确保符合 VBV，同时保持最佳视觉质量分布。

VBV 兼容性：系统会根据实时缓冲区填充计算(ratecontrol.c:1589-1596)进行 QP 调整，从而防止缓冲区下溢和上溢。当 QP 跳跃过大时，它甚至可以触发行重新编码(ratecontrol.c:1622-1631)。

提升比特率精度：通过在编码过程中而非仅在帧边界处调整量化参数 (QP)，系统实现了更精确的比特率目标定位。该算法会根据实际编码结果持续更新预测器(ratecontrol.c:1518-1522)。

质量分布：当帧相对于缓冲区约束ratecontrol.c:1613-1617消耗过多的比特时，行级控制允许增加 QP，从而有助于防止复杂区域的质量下降。

线程支持：实现包括对切片线程场景的特殊处理，根据其他并发切片的估计大小调整决策ratecontrol.c:1547-1561。

笔记
行级码率控制仅在启用 VBV（b_vbv标志）时有效，因为它是专门为确保符合视频缓冲限制而设计的。系统为不同的切片类型维护单独的预测器，并通过在编码过程中持续更新的自适应预测器系数自动适应编码复杂度。



***

`x264_ratecontrol_mb`函数是x264编码器中实现**行级码控**的核心函数，主要用于VBV (Video Buffering Verifier)合规性控制。以下是其主要工作原理：

## 函数调用时机与基本功能

该函数在每个宏块行编码完成后被调用 ratecontrol.c:1496-1505 ，主要负责：

1. 累计当前行的比特数
1. 更新QP统计信息
1. 只有当到达行尾时才进行码控处理

## 主要码控思想

### 1. 预测模型更新

函数使用两个预测器来跟踪编码统计信息 ratecontrol.c:1517-1522 ：

+ `row_pred[0]`：用于一般情况的行大小预测
+ `row_pred[1]`：用于QP低于参考帧时的预测

### 2. 行大小预测机制

核心预测函数`predict_row_size`采用混合预测策略 ratecontrol.c:1446-1472 ：

+ 基于SATD的绝对预测
+ 基于参考帧相应行的比例缩放预测
+ 根据帧类型和QP关系选择不同的预测组合

### 3. VBV缓冲区控制

通过预测剩余行的比特消耗来进行QP调整 ratecontrol.c:1575-1596 ：

+ 计算已编码比特数加上剩余行的预测比特数
+ 与计划的帧大小和VBV缓冲区状态进行比较
+ 当预测超出限制时，递增QP直到满足约束

### 4. 动态QP调整策略

函数实现双向QP调整 ratecontrol.c:1599-1610 ：

+ **上调QP**：当预测比特数超出VBV限制时
+ **下调QP**：当预测比特数过低且有缓冲余量时
+ 确保VBV不会下溢或上溢

### 5. 重新编码机制

当QP调整过大时，支持重新编码当前行 ratecontrol.c:1622-1631 ，这是防止质量剧烈波动的重要机制。

## 预测模型核心算法

预测器使用线性模型 ratecontrol.c:2026-2028 ：

```
预测比特数 = (coeff × variance + offset) / (qscale × count)  
```

模型参数通过自适应更新机制持续优化 ratecontrol.c:2031-2055 ，确保预测精度随编码过程不断提升。

## 总结

`x264_ratecontrol_mb`的核心思想是通过**预测式控制**实现行级的精确码率分配，确保在满足VBV约束的前提下，尽可能维持稳定的视觉质量。其关键创新在于结合了基于复杂度的预测和基于参考帧的时域预测，形成了鲁棒的自适应码控系统。

## Notes

该函数实际上是在宏块行级别进行控制，而不是单个宏块级别。它是x264 VBV控制系统的核心组件，确保编码后的码流能够在标准解码器的VBV缓冲区中正确播放。
