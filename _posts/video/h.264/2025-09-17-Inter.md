---
layout: post
title: H.264 帧间预测
slug: h264-inter-prediction
categories: [视频开发]
tags: [H.264]
---

**帧间预测（Inter-prediction）**核心思想：消除时间冗余



如果说帧内预测利用的是 **空间上的相似性**，那么帧间预测利用的就是**时间上的相似性**。视频是由連續的圖像序列组成的，相鄰的幾帧画面之间通常只有很小的变化（例如，一個移动的物體或攝像機的平移）。帧间预测的目的，就是利用这种 **时间相关性（Temporal Correlation）** 来消除数据冗余。

其基本原理是：**不再编码完整的当前帧，而是将其与已经编码好的“参考帧”（通常是前一帧或后一帧）进行比较，找到当前帧中某个区域在参考帧中的最佳匹配块。然后，系统只需编码这个“位置偏移信息”（即运动矢量, Motion Vector）和两者之间的“细微差异”（即残差, Residual）。** 由于运动矢量和残差的数据量远小于原始像素数据，从而实现了极高的压缩率。


整个过程分为两大步骤：

1. **运动估计 (Motion Estimation, ME)**：在编码器端进行，为当前宏块在参考帧中寻找最佳匹配块，并计算出运动矢量（MV）。
1. **运动补偿 (Motion Compensation, MC)**：在编码器和解码器端都会进行，根据运动矢量从参考帧中“取出”预测块。



### P 帧与 B 帧：不同的参考方式

H.264 的帧间预测主要应用于两种类型的帧：

+ **P 帧 (Predictive Coded Picture)**：**前向预测帧**。它只参考其 **前面** 已经编码好的帧（I 帧或 P 帧）来进行预测。P 帧的压缩率较高，是构成视频序列的主力。
+ **B 帧 (Bi-directionally Predictive Coded Picture)**：**双向预测帧**。它既可以参考其前面的帧，也可以参考其 **后面** 的帧，甚至可以同时参考前后两帧进行 **双向预测**。这使得 B 帧的压缩率最高，因为它能找到最优的匹配块。例如，一个被暂时遮挡又重新出现的物体，用 B 帧就能很好地处理。



### 运动估计（ME）：如何找到最佳匹配？

运动估计是帧间预测中最关键也最耗费计算资源的一步。编码器需要为当前帧的每个宏块完成这项工作。

#### 1. 可变尺寸的块划分 (Variable Block Sizes)

H.264 的一大革新是引入了灵活的宏块划分。一个 16x16 的宏块不再是最小的运动估计单元，它可以被划分为更小的子块。这种设计能够更好地适应画面中不同物体的运动状态：大面积平移的背景可以用大尺寸块，而运动复杂、细节丰富的小物体则可以用小尺寸块来更精确地描述。

支持的划分尺寸包括：

+ **16x16**
+ **16x8**
+ **8x16**
+ **8x8**

当划分为 8x8 后，每个 8x8 的子块还可以进一步划分为：

+ **8x8**
+ **8x4**
+ **4x8**
+ **4x4**


编码器会使用 **率失真优化 (RDO)** 算法，尝试所有可能的划分方式，最终选择一种能在保证图像质量的前提下，编码（运动矢量+残差）比特数最少的方式。

#### 2. 运动矢量 (Motion Vector, MV)

运动矢量是一个二维向量 (MV_x,MV_y)，它描述了当前块相对于参考帧中最佳匹配块的位置偏移。例如，一个值为 (10, -5) 的运动矢量表示“从当前块的位置，向右移动 10 个像素，向上移动 5 个像素，就能在参考帧里找到匹配块”。

#### 3. 亚像素级精度 (Sub-pixel Accuracy)

物体的运动不可能是像素级别的整数倍。为了更精确地进行预测，H.264 支持亚像素精度的运动估计，包括：

+ **半像素 (Half-pixel)**
+ **四分之一像素 (Quarter-pixel)**

这并不是说物理像素可以再被分割，而是通过对参考帧的整数像素进行 **插值（Interpolation）** 来生成虚拟的亚像素点。H.264 使用一个 **6-tap 的 FIR 滤波器** 来计算半像素点的值，再通过对半像素点进行线性插值得到四分之一像素点的值。

虽然这极大地增加了计算复杂度，但亚像素技术能显著提高预测的准确性，从而大幅减少残差数据，提升压缩效率。

### 运动补偿（MC）：如何重建预测块？

运动补偿的过程相对简单，解码器和编码器都会执行。

1. **获取运动矢量和参考帧索引**：解码器从码流中解析出当前块的运动矢量 (MV) 和它所引用的参考帧是哪一帧。
1. **定位参考块**：根据 MV，在指定的参考帧中定位到匹配块的位置。如果 MV 是亚像素精度的，解码器会执行与编码器完全相同的插值算法来计算出亚像素位置的像素值。
1. **生成预测块**：将参考块的像素值复制过来，作为当前块的预测块 (Predicted Block)。
1. **解码残差并重建**：解码器从码流中解析出经过反量化、反变换后的残差数据。
1. **最终重建**：将 **预测块** 与 **残差数据** 相加，就得到了最终重建的像素块。

**公式：`重建块 = 预测块 + 解码后的残差块`**

对于 B 帧的双向预测，过程类似：解码器会同时获取前向和后向的两个运动矢量，分别从前向和后向参考帧中取出两个预测块，然后将这两个块进行 **加权平均**，生成最终的预测块。

------




