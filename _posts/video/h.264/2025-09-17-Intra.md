---
layout: post
title: H.264 帧内预测
slug: h264-intra-prediction
categories: [视频开发]
tags: [H.264]
date: 2025-09-17 01:00:00 +0800
---

帧内预测核心思想：**消除空间冗余**

相邻的像素之间通常存在着极高的相似性。帧内预测利用**空间相关性**来消除数据冗余，从而实现高效压缩。

其基本原理是：**不直接编码每个像素的原始值，而是先根据其邻近像素（已经编码完成的左侧和上方像素）来预测它的值，然后只对原始值与预测值之间的差值（即残差）进行编码和传输。** 由于这个差值通常很小（甚至是零），编码它所需的数据量远小于编码原始像素值所需的数据量。

帧内预测包含4种类型：

+   对于亮度分量：
    1.  **16x16**：适用于大面积平坦区域。
    1.  **4x4**：适用于纹理细节丰富的区域。
    1.  **8x8**：仅在High Profile中支持。
+   对于亮度分量：
    1.   在**8x8**的块上进行。

***

预测的关键是利用**当前块左边和上边的、已经被解码和重建的像素**作为参考，它保证了编码器和解码器可以使用完全相同的参考像素，生成完全一致的预测块。

```
      M I J K L A B C D E F G H
      A p p p p
      B p p p p
      C p p p p
      D p p p p
```

+   `p`: 代表当前需要预测的4x4块中的像素。
+   `A, B, C, D`: 代表当前块左侧的4个可用参考像素。
+   `I, J, K, L`: 代表当前块上方的4个可用参考像素。
+   `M`: 代表当前块左上角的参考像素。
+   `E, F, G, H`: 代表右上方的参考像素。

**注意**：参考像素不是原始图像的像素，而是**重建后**的像素（反量化、反变换的像素）。防止编解码器之间的误差累积。



### 亮度分量预测

#### Intra_4x4 (9种)

Intra_4x4 预测适用于包含大量细节的区域。它有9种预测模式，其中8种是方向性预测，1种是直流（DC）预测。

```
      M I J K L  (上方参考像素)
      A x x x x  <- 待预测像素 p(i,j)
      B x x x x
      C x x x x
      D x x x x
      ^
      |
 (左侧参考像素)
```

+   **Mode 0 (Vertical):** 垂直预测。块中的每个像素都由其正上方的参考像素 `I, J, K, L` 复制而来。
    +   `pred(i, j) = p(i, -1)` 
+   **Mode 1 (Horizontal):** 水平预测。块中的每个像素都由其左侧的参考像素 `A, B, C, D` 复制而来。
    +   `pred(i, j) = p(-1, j)`
+   **Mode 2 (DC):** 直流预测。所有像素都等于上方和左侧8个参考像素（`A,B,C,D,I,J,K,L`）的平均值。适用于没有明显纹理方向的平坦区域。
    +   `pred(i, j) = (A+B+C+D+I+J+K+L+4) >> 3`
+   **Mode 3 (Diagonal Down-Left):** 右上对角线预测。像素值由上方和右上方的参考像素沿约-45度方向预测得到。
    +   `pred(i,j) = (p(i+j, -1) + 2*p(i+j+1, -1) + p(i+j+2, -1) + 2) >> 2`
+   **Mode 4 (Diagonal Down-Right):** 左下对角线预测。像素值由上方、左方和左上方的参考像素沿约+45度方向预测得到。
    +   `pred(i, j)` 的计算较为复杂，依赖于 `p(i-j, -1)`, `p(-1, j-i)` 等。
+   **Mode 5 (Vertical-Right):** 垂直向右预测。
+   **Mode 6 (Horizontal-Down):** 水平向下预测。
+   **Mode 7 (Vertical-Left):** 垂直向左预测。
+   **Mode 8 (Horizontal-Up):** 水平向上预测。

这4种（Mode 5-8）都是对角线预测的微调，通过不同权重的加权平均来实现不同角度的预测。

#### Intra_16x16 (4种)

Intra_16x16 预测适用于大面积平坦区域，计算复杂度较低。它只有4种模式。

+   **Mode 0 (Vertical):** 垂直预测。与4x4模式类似，每一列都由其上方的参考像素复制得到。
+   **Mode 1 (Horizontal):** 水平预测。与4x4模式类似，每一行都由其左侧的参考像素复制得到。
+   **Mode 2 (DC):** 直流预测。所有像素都等于上方16个和左侧16个参考像素的平均值。
+   **Mode 3 (Plane):** 平面预测。这是一种更复杂的模式。它假设块内像素值是一个线性变化的平面。通过左侧、上方和左上角的参考像素计算出一个平面方程 `H*x + V*y + C`，然后用这个方程为块内每个像素生成预测值。这能很好地处理渐变光照的场景。

#### Intra_8x8  (9种)

这9种模式与Intra_4x4的模式非常相似，只是作用于8x8的块，并使用16个上方和8个左侧的相邻像素进行预测。这是对4x4模式的一种扩展，同样在High Profile中提供。

### 色度分量

色度分量（Cb 和 Cr）通常比亮度分量平坦，因此其预测模式也相对简单。通常对整个8x8的色度块进行一次预测，模式有4种，与 Intra_16x16 的亮度预测模式完全一样：

+   **Mode 0 (DC)**
+   **Mode 1 (Horizontal)**
+   **Mode 2 (Vertical)**
+   **Mode 3 (Plane)**



### 模式选择

解码器只需要根据码流中指定的模式进行预测即可。但对于编码器，它需要找到“最佳”的预测模式。这个过程被称为**率失真优化 (Rate-Distortion Optimization, RDO)**。

对于一个宏块（Macroblock），编码器的大致流程如下：

1.  **遍历所有可能的模式组合**。例如，对于一个16x16的宏块，编码器会尝试：

    +   将其作为一个 Intra_16x16 块，并计算4种模式的代价。
    +   将其分割成16个 Intra_4x4 块，并为每个4x4块在9种模式中寻找最佳模式。
    +   (如果支持) 将其分割成4个 Intra_8x8 块，并为每个8x8块在9种模式中寻找最佳模式。

1.  **计算每种模式的代价 (Cost)**。代价不仅仅是预测误差的大小，它是一个综合了“失真”和“码率”的指标。

    +   **失真 (Distortion, D):** 通常用SAD或 SATD来快速衡量预测残差的大小。

        $$ SAD = \sum_{i=0}^{N-1}\sum_{j=0}^{N-1} |\text{Original}(i,j) - \text{Predicted}(i,j)|$$

    +   **码率 (Rate, R):** 指的是编码该模式的类型信息以及编码残差数据所需要的比特数。

    +   **代价函数:**

        $$ J = D + \lambda \cdot R $$

         其中 λ 是一个拉格朗日乘子，用于平衡码率和失真。

1.  **选择代价最小的模式**。编码器会选择使代价 J 最小的模式（或者模式组合）作为该宏块的最终编码方式。

1.  **编码输出**。将选择的最佳预测模式信息和经过变换、量化后的残差数据写入到码流中。
