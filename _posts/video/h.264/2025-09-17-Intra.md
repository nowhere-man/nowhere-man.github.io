---
layout: post
title: H.264 帧内预测
slug: h264-intra-prediction
categories: [视频开发]
tags: [H.264]
---

**帧内预测（Intra-prediction）**核心思想：消除空间冗余

在视频画面中，相邻的像素之间通常存在着极高的相似性。例如，在一片蓝天或一面白墙的区域，一个像素的值和它旁边的像素值几乎完全相同。帧内预测的目的，就是利用这种 **空间相关性（Spatial Correlation）** 来消除数据冗余，从而实现高效压缩。

其基本原理是：**不直接编码每个像素的原始值，而是先根据其“邻居”（已经编码完成的左侧和上方像素）来预测它的值，然后只对“原始值”与“预测值”之间的差值（即残差，Residual）进行编码和传输。** 由于这个差值通常很小（甚至是零），编码它所需的数据量远小于编码原始像素值所需的数据量。

H.264 的帧内预测技术非常精细，它定义了多种预测模式，以适应图像中不同方向的纹理。解码端会执行完全相同的预测过程，然后将接收到的残差数据与预测值相加，就能完美地恢复出原始图像。

H.264 的帧内预测主要针对亮度（Luma, Y）和色度（Chroma, Cb/Cr）分量，并根据图像内容的平坦或复杂程度，提供了三种不同尺寸的预测块：

1. **I-16x16 模式**：适用于大面积、纹理平坦的区域（如天空、墙壁）。
1. **I-8x8 模式**：适用于中等细节和纹理的区域（目前使用较少，通常在 High Profile 中支持）。
1. **I-4x4 模式**：适用于细节丰富、纹理复杂的区域（如边缘、毛发）。

编码器会通过复杂的 **率失真优化（Rate-Distortion Optimization, RDO）** 算法来为每个宏块选择最佳的预测尺寸和模式，以达到压缩率和图像质量的最佳平衡。

------



### 亮度分量（Luma）的预测模式

亮度分量包含了图像的主要细节信息，因此 H.264 为其设计了最丰富的预测模式。

#### 1. I-16x16 预测模式（4种）

这种模式将整个 16x16 的亮度宏块作为一个单元进行预测。它只有 4 种模式，因为大块区域的纹理变化通常比较简单。预测所需的参考像素是该宏块左边一列的 16 个像素和上方一行的 16 个像素。

+ **模式 0 (Vertical, 垂直预测)**：使用上方相邻的像素 `A, B, ..., P` 从上到下填充整个宏块。适合垂直纹理。
+ **模式 1 (Horizontal, 水平预测)**：使用左侧相邻的像素 `Q, R, ..., Z` 从左到右填充整个宏块。适合水平纹理。
+ **模式 2 (DC, 直流预测)**：计算所有上方和左侧参考像素的平均值，并用这个平均值填充整个宏块。适用于极其平坦的区域。
+ **模式 3 (Plane, 平面预测)**：通过上方和左侧的参考像素拟合一个平面方程，然后用这个平面来生成预测值。它能处理渐变光照等场景，效果比 DC 模式更平滑自然。

#### 2. I-4x4 预测模式（9种）

这是 H.264 帧内预测最精细的模式，将 16x16 的宏块划分为 16 个 4x4 的小块，每个小块独立进行预测和模式选择。它能极好地适应图像的边缘和细节。预测所需的参考像素是该 4x4 小块左边和上方的 13 个相邻像素（如下图 A-M）。

这 9 种模式包括：

+ **模式 0 (Vertical)**: 垂直预测
+ **模式 1 (Horizontal)**: 水平预测
+ **模式 2 (DC)**: 直流预测（计算 8 个参考像素的平均值）
+ **模式 3 (Diagonal Down-Left)**: 45 度左下对角线预测
+ **模式 4 (Diagonal Down-Right)**: 45 度右下对角线预测
+ **模式 5 (Vertical-Right)**: 约 26.6 度右下预测
+ **模式 6 (Horizontal-Down)**: 约 26.6 度右下预测
+ **模式 7 (Vertical-Left)**: 约 26.6 度左下预测
+ **模式 8 (Horizontal-Up)**: 约 26.6 度左上预测

这 8 个方向性预测覆盖了从水平、垂直到各个角度的纹理方向，使得 H.264 能够精准地刻画图像的边缘细节。



------



### 色度分量（Chroma）的预测模式

人眼对色度的变化没有亮度敏感，因此色度分量的预测模式相对简单。色度块（Cb 和 Cr）的大小通常是 8x8。其预测模式与 I-16x16 亮度的模式非常相似，也是 4 种：

+ **模式 0 (DC, 直流预测)**
+ **模式 1 (Horizontal, 水平预测)**
+ **模式 2 (Vertical, 垂直预测)**
+ **模式 3 (Plane, 平面预测)**

其预测方式和原理与 I-16x16 亮度模式完全相同，只是作用于 8x8 的色度块。
